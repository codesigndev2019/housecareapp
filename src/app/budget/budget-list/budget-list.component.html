<div class="page-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">{{ 'budget.title' | translate }}</h1>
        <p class="page-subtitle">{{ 'budget.subtitle' | translate }}</p>
      </div>
      <div class="header-actions">
        <mat-form-field appearance="outline" class="currency-selector">
          <mat-label>{{ 'budget.currency' | translate }}</mat-label>
          <mat-select [(value)]="selectedCurrency" (selectionChange)="onCurrencyChange()">
            @for (curr of currencies; track curr.value) {
              <mat-option [value]="curr.value">
                {{ curr.symbol }} {{ curr.value }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
        <button mat-raised-button color="primary" class="add-btn" (click)="openCreate()">
          <mat-icon>add</mat-icon>
          <span>{{ 'budget.add' | translate }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  @if (summary$ | async; as summary) {
    <div class="summary-cards">
      <!-- Total Income Card -->
      <div class="summary-card income-card">
        <div class="card-icon">
          <mat-icon>trending_up</mat-icon>
        </div>
        <div class="card-content">
          <span class="card-label">{{ 'budget.totalIncome' | translate }}</span>
          <span class="card-value income-value">
            {{ getCurrencySymbol(summary.currency) }} {{ summary.totalIncome | number:'1.2-2' }}
          </span>
        </div>
      </div>

      <!-- Total Expenses Card -->
      <div class="summary-card expense-card">
        <div class="card-icon">
          <mat-icon>trending_down</mat-icon>
        </div>
        <div class="card-content">
          <span class="card-label">{{ 'budget.totalExpenses' | translate }}</span>
          <span class="card-value expense-value">
            {{ getCurrencySymbol(summary.currency) }} {{ summary.totalExpenses | number:'1.2-2' }}
          </span>
        </div>
      </div>

      <!-- Balance Card -->
      <div class="summary-card balance-card" [class.positive]="summary.balance >= 0" [class.negative]="summary.balance < 0">
        <div class="card-icon">
          <mat-icon>{{ summary.balance >= 0 ? 'account_balance_wallet' : 'warning' }}</mat-icon>
        </div>
        <div class="card-content">
          <span class="card-label">{{ 'budget.balance' | translate }}</span>
          <span class="card-value balance-value">
            {{ getCurrencySymbol(summary.currency) }} {{ summary.balance | number:'1.2-2' }}
          </span>
        </div>
      </div>
    </div>
  }

  <!-- Search Bar -->
  <div class="search-bar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-icon matPrefix class="search-icon">search</mat-icon>
      <input 
        matInput 
        (keyup)="applyFilter($any($event.target).value)" 
        [placeholder]="'budget.searchPlaceholder' | translate"
        #searchInput>
      @if (dataSource.filter) {
        <button 
          mat-icon-button 
          matSuffix 
          (click)="applyFilter(''); searchInput.value=''" 
          class="clear-btn">
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>
  </div>

  <!-- Table Card -->
  <div class="table-card">
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="budget-table">

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'budget.movementName' | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="cell-content">
              <span class="movement-name">{{ row.name }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>
            {{ 'budget.description' | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="cell-content">
              <span class="text-secondary description-cell">{{ row.description || '-' }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Movement Type Column -->
        <ng-container matColumnDef="movementType">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'budget.movementType' | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="cell-content">
              <span class="type-chip" [class.income]="row.movementType === 'income'" [class.expense]="row.movementType === 'expense'">
                <mat-icon class="type-icon">{{ row.movementType === 'income' ? 'trending_up' : 'trending_down' }}</mat-icon>
                {{ (row.movementType === 'income' ? 'budget.income' : 'budget.expense') | translate }}
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Currency Column -->
        <ng-container matColumnDef="currency">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'budget.currency' | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="cell-content">
              <span class="currency-badge">{{ row.currency }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'budget.amount' | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="cell-content">
              <span class="amount-value" [class.income]="row.movementType === 'income'" [class.expense]="row.movementType === 'expense'">
                {{ getCurrencySymbol(row.currency) }} {{ row.amount | number:'1.2-2' }}
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Fixed Column -->
        <ng-container matColumnDef="isFixed">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'budget.isFixed' | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="cell-content">
              <mat-icon class="fixed-icon" [class.is-fixed]="row.isFixed">
                {{ row.isFixed ? 'repeat' : 'schedule' }}
              </mat-icon>
              <span class="fixed-label">{{ (row.isFixed ? 'budget.fixed' : 'budget.variable') | translate }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header"></th>
          <td mat-cell *matCellDef="let row" class="actions-cell">
            <div class="action-buttons">
              <button 
                mat-icon-button 
                class="action-btn view-btn" 
                (click)="openView(row)" 
                [matTooltip]="'actions.view' | translate">
                <mat-icon>visibility</mat-icon>
              </button>
              <button 
                mat-icon-button 
                class="action-btn edit-btn" 
                (click)="openEdit(row)" 
                [matTooltip]="'actions.edit' | translate">
                <mat-icon>edit</mat-icon>
              </button>
              <button 
                mat-icon-button 
                class="action-btn delete-btn" 
                (click)="onDelete(row)" 
                [matTooltip]="'actions.delete' | translate">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row 
            *matRowDef="let row; columns: displayedColumns;" 
            class="table-row"
            tabindex="0"
            (keydown.enter)="openEdit(row)"
            [attr.aria-label]="row.name + ' - ' + ('accessibility.tableRowAction' | translate)"
            role="row"></tr>
      </table>

      <!-- Empty State -->
      @if (dataSource.data.length === 0) {
        <div class="empty-state">
          <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
          <p class="empty-title">{{ 'budget.empty' | translate }}</p>
          <p class="empty-subtitle">{{ 'budget.emptySubtitle' | translate }}</p>
          <button mat-stroked-button color="primary" (click)="openCreate()">
            {{ 'budget.add' | translate }}
          </button>
        </div>
      }
    </div>

    <!-- Paginator -->
    <mat-paginator 
      class="table-paginator"
      [pageSizeOptions]="[5, 10, 20, 50]" 
      [pageSize]="10"
      showFirstLastButtons
      aria-label="Select page">
    </mat-paginator>
  </div>
</div>
